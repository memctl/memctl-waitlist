---
import { KIT_FORM_ID, KIT_API_KEY } from '../consts';
---

<form
  data-waitlist-form
  data-form-id={KIT_FORM_ID}
  data-api-key={KIT_API_KEY}
  class="flex flex-col sm:flex-row gap-2.5 w-full max-w-md"
>
  <input
    type="email"
    name="email"
    placeholder="you@example.com"
    required
    class="flex-1 h-12 px-4 rounded-xl border border-[var(--border)] bg-[var(--surface)] text-[var(--text)] placeholder-[var(--tertiary)] text-sm outline-none transition-all focus:border-[#F97316]/50 focus:ring-2 focus:ring-[#F97316]/10"
  />
  <button
    type="submit"
    class="h-12 px-7 rounded-xl bg-[#F97316] hover:bg-[#EA580C] active:scale-[0.98] text-white font-semibold text-sm transition-all cursor-pointer whitespace-nowrap shadow-[0_1px_12px_rgba(249,115,22,0.25)] hover:shadow-[0_1px_20px_rgba(249,115,22,0.35)]"
  >
    Join Waitlist
  </button>
  <p data-waitlist-msg class="hidden absolute -bottom-6 left-0 text-xs"></p>
</form>

<script>
  function initWaitlistForms() {
    document.querySelectorAll('[data-waitlist-form]').forEach((form) => {
      const f = form as HTMLFormElement;
      if (f.dataset.initialized) return;
      f.dataset.initialized = 'true';

      f.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formId = f.dataset.formId;
        const apiKey = f.dataset.apiKey;
        const emailInput = f.querySelector('input[name="email"]') as HTMLInputElement;
        const btn = f.querySelector('button') as HTMLButtonElement;
        const msg = f.querySelector('[data-waitlist-msg]') as HTMLElement;
        const email = emailInput?.value?.trim();

        if (!email) return;

        btn.disabled = true;
        btn.textContent = 'Joining...';
        msg.classList.add('hidden');

        try {
          const res = await fetch(
            `https://api.convertkit.com/v3/forms/${formId}/subscribe`,
            {
              method: 'POST',
              headers: { 'Content-Type': 'application/json; charset=utf-8' },
              body: JSON.stringify({ api_key: apiKey, email }),
            }
          );

          if (res.ok) {
            btn.textContent = 'You\'re in!';
            btn.classList.remove('bg-[#F97316]', 'hover:bg-[#EA580C]');
            btn.classList.add('bg-[#22C55E]');
            emailInput.value = '';
            setTimeout(() => {
              btn.textContent = 'Join Waitlist';
              btn.classList.remove('bg-[#22C55E]');
              btn.classList.add('bg-[#F97316]', 'hover:bg-[#EA580C]');
              btn.disabled = false;
            }, 3000);
          } else {
            throw new Error('Request failed');
          }
        } catch {
          msg.textContent = 'Something went wrong. Try again.';
          msg.classList.remove('hidden');
          msg.classList.add('text-red-500');
          btn.textContent = 'Join Waitlist';
          btn.disabled = false;
          setTimeout(() => msg.classList.add('hidden'), 4000);
        }
      });
    });
  }

  initWaitlistForms();
  document.addEventListener('astro:after-swap', initWaitlistForms);
</script>
